<!doctype html>
<html>

<head>
  <title>Sandbox</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <link href="
https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css
" rel="stylesheet">
</head>

<body>
  Container id: {{ . }}
  <div id="terminal"></div>
</body>

<script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-attach@0.11.0/lib/addon-attach.min.js"></script>
<script>
  (() => {
    //wss://docker:2375/containers/[ID_CONTAINER]/attach/ws
    const term = new Terminal({
      cursorBlink: true
    })
    const bufferToStr = (buffer) => {
      const buff = new Uint8Array(buffer);
      return new TextDecoder().decode(buff);
    };
    const strToBuffer = (str) => new TextEncoder().encode(str);
    const dockerContainerID = "{{ .ContainerID }}"
    const socket = new WebSocket(`ws://localhost:2377/containers/${dockerContainerID}/attach/ws?stdin=true&stdout=true&stream=true`);
    const attachAddon = new window.AttachAddon.AttachAddon(socket);
    // term.write('Hello from \x1B[1;3;31mxterm.js\x1B[0m $ ')
    term.loadAddon(attachAddon);
    term.open(document.getElementById('terminal'))




    term.prompt = () => {
      term.write('\r\n$ ');
    };
    prompt(term);

    term.onData(e => {
      switch (e) {
        case '\u0003': // Ctrl+C
          term.write('^C');
          prompt(term);
          break;
        case '\r': // Enter
          runCommand(term, command);
          command = '';
          break;
        case '\u007F': // Backspace (DEL)
          // Do not delete the prompt
          if (term._core.buffer.x > 2) {
            term.write('\b \b');
            if (command.length > 0) {
              command = command.substr(0, command.length - 1);
            }
          }
          break;
        case '\u0009':
          console.log('tabbed', output, ["dd", "ls"]);
          break;
        default:
          if (e >= String.fromCharCode(0x20) && e <= String.fromCharCode(0x7E) || e >= '\u00a0') {
            command += e;
            term.write(e);
          }
      }
    });

    function clearInput(command) {
      var inputLengh = command.length;
      for (var i = 0; i < inputLengh; i++) {
        term.write('\b \b');
      }
    }

    function prompt(term) {
      command = '';
      term.write('\r\n$ ');
    }
    
    socket.onmessage = (event) => {
      console.log('nova msg do docker', bufferToStr(event.data));
      term.write(event.data);
    }

    function runCommand(term, command) {
      if (command.length > 0) {
        clearInput(command);
        socket.send(command + '\n');
        return;
      }
    }
  })();

</script>

</html>